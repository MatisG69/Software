import { useState, useEffect, useMemo } from 'react';
import { Layout } from '../../components/Layout';
import { useAuth } from '../../context/AuthContext';
import { 
  Shield, CheckCircle, XCircle, Save, Edit, Lock, Lightbulb, MapPin, User, Mail, 
  GraduationCap, Briefcase, Code, Globe, Clock, Building2, Target, Award, 
  FileText, Link as LinkIcon, Github, Linkedin, Camera, Eye, EyeOff, Settings,
  TrendingUp, BarChart3, Zap, Star, AlertCircle, CheckCircle2, X, Plus, Trash2,
  Calendar, MapPin as MapPinIcon, Languages, Home, Plane, BriefcaseIcon,
  Users, Heart, Brain, Rocket, Filter, Bell, BellOff, Eye as EyeIcon
} from 'lucide-react';
import { Link } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { Progress } from '@/components/ui/progress';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { getCandidateProfile, updateCandidateProfile } from '@/lib/supabase';

export const CandidateProfile = () => {
  const { candidate } = useAuth();
  const [editing, setEditing] = useState(false);
  const [loading, setLoading] = useState(false);
  const [profileLoading, setProfileLoading] = useState(true);
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    bio: '',
    location: '',
    experience: 0,
    education: '',
    skills: '',
  });

  useEffect(() => {
    const loadProfile = async () => {
      if (!candidate?.id) return;
      setProfileLoading(true);
      try {
        const profile = await getCandidateProfile(candidate.id);
        if (profile) {
          setFormData({
            firstName: profile.firstName || '',
            lastName: profile.lastName || '',
            bio: profile.profile?.bio || '',
            location: profile.profile?.location || '',
            experience: profile.profile?.experience || 0,
            education: profile.profile?.education || '',
            skills: profile.profile?.skills?.join(', ') || '',
          });
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      } finally {
        setProfileLoading(false);
      }
    };

    loadProfile();
  }, [candidate?.id]);

  const handleSave = async () => {
    if (!candidate?.id) return;

    setLoading(true);
    try {
      const skillsArray = formData.skills
        .split(',')
        .map((s) => s.trim())
        .filter((s) => s.length > 0);

      const success = await updateCandidateProfile(candidate.id, {
        firstName: formData.firstName,
        lastName: formData.lastName,
        profile: {
          bio: formData.bio,
          location: formData.location,
          experience: formData.experience,
          education: formData.education,
          skills: skillsArray,
        },
      });

      if (success) {
        setEditing(false);
        // Recharger le profil
        const profile = await getCandidateProfile(candidate.id);
        if (profile) {
          setFormData({
            firstName: profile.firstName || '',
            lastName: profile.lastName || '',
            bio: profile.profile?.bio || '',
            location: profile.profile?.location || '',
            experience: profile.profile?.experience || 0,
            education: profile.profile?.education || '',
            skills: profile.profile?.skills?.join(', ') || '',
          });
        }
      } else {
        alert('Erreur lors de la sauvegarde du profil');
      }
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('Erreur lors de la sauvegarde du profil');
    } finally {
      setLoading(false);
    }
  };

  if (profileLoading) {
    return (
      <Layout>
        <div className="flex items-center justify-center py-12">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p className="text-muted-foreground">Chargement du profil...</p>
          </div>
        </div>
      </Layout>
    );
  }

  return (
    <Layout>
      <div className="space-y-8 min-h-screen pb-12">
        {/* Header amélioré */}
        <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
          <h1 className="text-4xl font-bold text-foreground">Mon profil</h1>
          {!editing ? (
            <Button 
              onClick={() => setEditing(true)}
              className="bg-primary hover:bg-primary/90 shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl px-6"
            >
              <Edit className="w-4 h-4 mr-2" />
              Modifier
            </Button>
          ) : (
            <div className="flex gap-3">
              <Button 
                variant="outline" 
                onClick={() => setEditing(false)}
                className="rounded-xl"
              >
                Annuler
              </Button>
              <Button 
                onClick={handleSave} 
                disabled={loading}
                className="bg-primary hover:bg-primary/90 shadow-lg hover:shadow-xl transition-all duration-300 rounded-xl"
              >
                <Save className="w-4 h-4 mr-2" />
                {loading ? 'Enregistrement...' : 'Enregistrer'}
              </Button>
            </div>
          )}
        </div>

        {/* Badge Profil certifié amélioré */}
        {candidate?.certified ? (
          <div className="relative overflow-hidden rounded-xl bg-gradient-to-r from-green-50 via-emerald-50 to-green-100 dark:from-green-950/40 dark:via-emerald-950/30 dark:to-green-900/20 border-2 border-green-200 dark:border-green-800 p-6 shadow-lg">
            <div className="absolute top-0 right-0 w-32 h-32 bg-green-200/20 dark:bg-green-800/20 rounded-bl-full"></div>
            <div className="relative flex items-center gap-4">
              <div className="flex items-center justify-center w-16 h-16 rounded-xl bg-green-100 dark:bg-green-900/50 flex-shrink-0 shadow-md">
                <Shield className="w-8 h-8 text-green-600 dark:text-green-400" />
              </div>
              <div className="flex-1">
                <h3 className="text-xl font-bold text-green-900 dark:text-green-100 mb-1 flex items-center gap-2">
                  <CheckCircle className="w-5 h-5" />
                  Profil certifié
                </h3>
                <p className="text-green-800 dark:text-green-200 text-sm">
                  Votre identité a été vérifiée. Les entreprises savent que votre profil est authentique.
                </p>
              </div>
            </div>
          </div>
        ) : (
          <div className="relative overflow-hidden rounded-xl bg-gradient-to-r from-yellow-50 via-amber-50 to-yellow-100 dark:from-yellow-950/40 dark:via-amber-950/30 dark:to-yellow-900/20 border-2 border-yellow-200 dark:border-yellow-800 p-6 shadow-lg">
            <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-200/20 dark:bg-yellow-800/20 rounded-bl-full"></div>
            <div className="relative flex items-center gap-4">
              <div className="flex items-center justify-center w-16 h-16 rounded-xl bg-yellow-100 dark:bg-yellow-900/50 flex-shrink-0 shadow-md">
                <Shield className="w-8 h-8 text-yellow-600 dark:text-yellow-400" />
              </div>
              <div className="flex-1">
                <h3 className="text-xl font-bold text-yellow-900 dark:text-yellow-100 mb-1">Profil non certifié</h3>
                <p className="text-yellow-800 dark:text-yellow-200 text-sm mb-4">
                  Vérifiez votre identité pour obtenir un badge de certification et augmenter vos chances.
                </p>
                <Button asChild variant="outline" className="border-yellow-600 dark:border-yellow-700 text-yellow-900 dark:text-yellow-100 hover:bg-yellow-200 dark:hover:bg-yellow-900/50 rounded-xl">
                  <Link to="/candidate/verification">Vérifier mon identité</Link>
                </Button>
              </div>
            </div>
          </div>
        )}

        {/* Profile Information - Design amélioré */}
        <Card className="border-2 border-border rounded-xl shadow-lg">
          <CardHeader className="pb-5 pt-6 px-6 border-b border-border">
            <div className="flex items-center gap-3">
              <div className="w-1.5 h-8 bg-primary rounded-full"></div>
              <CardTitle className="text-2xl font-bold text-foreground">Informations personnelles</CardTitle>
            </div>
          </CardHeader>
          <CardContent className="pt-6 px-6 pb-6">
            <div className="grid md:grid-cols-2 gap-6">
              {/* Prénom */}
              <div className="space-y-2">
                <Label htmlFor="firstName" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <User className="w-4 h-4" />
                  Prénom
                </Label>
                {editing ? (
                  <Input
                    id="firstName"
                    type="text"
                    value={formData.firstName}
                    onChange={(e) => setFormData({ ...formData, firstName: e.target.value })}
                    className="mt-2 border-2 rounded-xl h-11"
                    placeholder="Votre prénom"
                  />
                ) : (
                  <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[44px] flex items-center">
                    <span className="text-foreground">{formData.firstName || 'Non renseigné'}</span>
                  </div>
                )}
              </div>

              {/* Nom */}
              <div className="space-y-2">
                <Label htmlFor="lastName" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <User className="w-4 h-4" />
                  Nom
                </Label>
                {editing ? (
                  <Input
                    id="lastName"
                    type="text"
                    value={formData.lastName}
                    onChange={(e) => setFormData({ ...formData, lastName: e.target.value })}
                    className="mt-2 border-2 rounded-xl h-11"
                    placeholder="Votre nom"
                  />
                ) : (
                  <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[44px] flex items-center">
                    <span className="text-foreground">{formData.lastName || 'Non renseigné'}</span>
                  </div>
                )}
              </div>

              {/* Email */}
              <div className="md:col-span-2 space-y-2">
                <Label htmlFor="email" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <Mail className="w-4 h-4" />
                  Email
                </Label>
                <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[44px] flex items-center">
                  <span className="text-foreground font-medium">{candidate?.email}</span>
                </div>
                <div className="flex items-start gap-2 mt-2 px-3 py-2 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-200 dark:border-blue-800">
                  <Lightbulb className="w-4 h-4 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" />
                  <p className="text-xs text-blue-800 dark:text-blue-200">
                    L'email n'est jamais partagé avec les entreprises pour préserver votre anonymat
                  </p>
                </div>
              </div>

              {/* Localisation */}
              <div className="md:col-span-2 space-y-2">
                <Label htmlFor="location" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <MapPin className="w-4 h-4" />
                  Localisation
                </Label>
                {editing ? (
                  <Input
                    id="location"
                    type="text"
                    value={formData.location}
                    onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                    className="mt-2 border-2 rounded-xl h-11"
                    placeholder="Ville, région ou télétravail"
                  />
                ) : (
                  <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[44px] flex items-center">
                    <span className="text-foreground">{formData.location || 'Non renseigné'}</span>
                  </div>
                )}
              </div>

              {/* Biographie */}
              <div className="md:col-span-2 space-y-2">
                <Label htmlFor="bio" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <User className="w-4 h-4" />
                  Biographie
                </Label>
                {editing ? (
                  <Textarea
                    id="bio"
                    value={formData.bio}
                    onChange={(e) => setFormData({ ...formData, bio: e.target.value })}
                    rows={5}
                    className="mt-2 border-2 rounded-xl resize-none"
                    placeholder="Parlez-nous de vous, de votre parcours et de vos aspirations..."
                  />
                ) : (
                  <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[120px] flex items-start">
                    <p className="text-foreground whitespace-pre-wrap leading-relaxed">
                      {formData.bio || 'Aucune biographie'}
                    </p>
                  </div>
                )}
              </div>

              {/* Années d'expérience */}
              <div className="space-y-2">
                <Label htmlFor="experience" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <Briefcase className="w-4 h-4" />
                  Années d'expérience
                </Label>
                {editing ? (
                  <Input
                    id="experience"
                    type="number"
                    value={formData.experience}
                    onChange={(e) => setFormData({ ...formData, experience: parseInt(e.target.value) || 0 })}
                    className="mt-2 border-2 rounded-xl h-11"
                    placeholder="0"
                    min="0"
                  />
                ) : (
                  <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[44px] flex items-center">
                    <span className="text-foreground">{formData.experience} {formData.experience > 1 ? 'ans' : 'an'}</span>
                  </div>
                )}
              </div>

              {/* Formation */}
              <div className="space-y-2">
                <Label htmlFor="education" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <GraduationCap className="w-4 h-4" />
                  Formation
                </Label>
                {editing ? (
                  <Input
                    id="education"
                    type="text"
                    value={formData.education}
                    onChange={(e) => setFormData({ ...formData, education: e.target.value })}
                    className="mt-2 border-2 rounded-xl h-11"
                    placeholder="Diplôme, école, université..."
                  />
                ) : (
                  <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[44px] flex items-center">
                    <span className="text-foreground">{formData.education || 'Non renseigné'}</span>
                  </div>
                )}
              </div>

              {/* Compétences */}
              <div className="md:col-span-2 space-y-2">
                <Label htmlFor="skills" className="text-sm font-semibold text-foreground flex items-center gap-2">
                  <Code className="w-4 h-4" />
                  Compétences
                </Label>
                {editing ? (
                  <Input
                    id="skills"
                    type="text"
                    value={formData.skills}
                    onChange={(e) => setFormData({ ...formData, skills: e.target.value })}
                    placeholder="Séparez les compétences par des virgules (ex: React, TypeScript, Node.js)"
                    className="mt-2 border-2 rounded-xl h-11"
                  />
                ) : (
                  <div className="px-4 py-3 bg-muted/50 rounded-xl border-2 border-border mt-2 min-h-[60px] flex items-center">
                    {formData.skills ? (
                      <div className="flex flex-wrap gap-2">
                        {formData.skills.split(',').map((skill, idx) => (
                          <Badge 
                            key={idx} 
                            variant="secondary" 
                            className="px-3 py-1.5 text-sm font-semibold bg-primary/10 border-2 border-primary/20 hover:border-primary/40 hover:bg-primary/20 hover:text-primary transition-all duration-200 rounded-lg"
                          >
                            {skill.trim()}
                          </Badge>
                        ))}
                      </div>
                    ) : (
                      <span className="text-muted-foreground">Aucune compétence renseignée</span>
                    )}
                  </div>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </Layout>
  );
};
